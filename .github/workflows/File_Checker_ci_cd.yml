name: CI - Build, Test, Scan & Push

on:
  push:
    branches: ["main"]

# Global environment variables
env:
  AWS_REGION: eu-north-1
  ECR_REPOSITORY: file-checker
  IMAGE_NAME: file-checker
  S3_BUCKET_NAME: "file-checker-${{ github.run_id }}-${{ github.run_number }}"

jobs:

  # ------------------------------------------------------------
  # JOB 1: BUILD
  # ------------------------------------------------------------
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Generate IMAGE_TAG
        run: |
          IMAGE_TAG="${ECR_REPOSITORY}-${GITHUB_REF_NAME}-${GITHUB_RUN_NUMBER}"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Build Docker image
        run: |
          echo "Building image: ${IMAGE_NAME}:${IMAGE_TAG}"
          docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .


  # ------------------------------------------------------------
  # JOB 2: TEST
  # ------------------------------------------------------------
  test:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v3

      - name: Show IMAGE_TAG
        run: echo "IMAGE_TAG=${IMAGE_TAG}"

      - name: Install dependencies
        run: npm ci

      - name: Audit vulnerabilities
        run: npm audit --audit-level=high || true

      - name: TypeScript compile
        run: npm run build --if-present

      - name: Run tests
        run: npm test --if-present


  # ------------------------------------------------------------
  # JOB 3: PUSH TO ECR
  # ------------------------------------------------------------
  push:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v3

      - name: Regenerate IMAGE_TAG
        run: |
          IMAGE_TAG="${ECR_REPOSITORY}-${GITHUB_REF_NAME}-${GITHUB_RUN_NUMBER}"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure ECR repo exists
        run: |
          aws ecr describe-repositories --repository-names "${ECR_REPOSITORY}" || \
          aws ecr create-repository --repository-name "${ECR_REPOSITORY}"

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Rebuild Docker image
        run: |
          docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .

      - name: Tag & Push images
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}"

          echo "Tagging image: ${IMAGE_NAME}:${IMAGE_TAG} â†’ ${ECR_URI}:${IMAGE_TAG}"

          docker tag ${IMAGE_NAME}:${IMAGE_TAG} "${ECR_URI}:${IMAGE_TAG}"
          docker tag ${IMAGE_NAME}:${IMAGE_TAG} "${ECR_URI}:latest"

          docker push "${ECR_URI}:${IMAGE_TAG}"
          docker push "${ECR_URI}:latest"

          echo "Pushed:"
          echo " - ${ECR_URI}:${IMAGE_TAG}"
          echo " - ${ECR_URI}:latest"

  # ------------------------------------------------------------
  # JOB 4: Terraform EKS Cluster+S3_Bucket
  # ------------------------------------------------------------
  deploy_infra:
    runs-on: ubuntu-latest
    needs: push

    env:
      AWS_REGION: us-east-1
      ENV_NAME: dev   #  stage/prod/staging

    steps:
      - uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.1
          
      - name: Terraform Init
        working-directory: terraform/envs/${{ env.ENV_NAME }}
        run: terraform init -upgrade

      - name: Terraform Validate
        working-directory: terraform/envs/${{ env.ENV_NAME }}
        run: terraform validate

      - name: Terraform Plan
        working-directory: terraform/envs/${{ env.ENV_NAME }}
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main'
        working-directory: terraform/envs/${{ env.ENV_NAME }}
        run: terraform apply -auto-approve tfplan
        
      ###########################################################
      # CREATE S3 BUCKET
      ###########################################################
      - name: Create S3 bucket
        run: |
          echo "Creating or validating S3 bucket: $S3_BUCKET_NAME"

          if aws s3api head-bucket --bucket "$S3_BUCKET_NAME" 2>/dev/null; then
            echo "Bucket exists."
          else
            echo "Creating bucket..."

            if [ "$AWS_REGION" = "us-east-1" ]; then
              aws s3api create-bucket \
                --bucket "$S3_BUCKET_NAME"
            else
              aws s3api create-bucket \
                --bucket "$S3_BUCKET_NAME" \
                --region $AWS_REGION \
                --create-bucket-configuration LocationConstraint=$AWS_REGION
            fi
          fi

          echo "BUCKET_NAME=$S3_BUCKET_NAME" >> $GITHUB_ENV

          
         
# ------------------------------------------------------------
# JOB 5: Deploy application to EKS
# ------------------------------------------------------------
  deploy_app:
    runs-on: ubuntu-latest
    needs: deploy_infra
  
    env:
      AWS_REGION: us-east-1
      ENV_NAME: dev
      File_Name: file.txt

    steps:
      - uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
  
      - name: Set up kubectl for AWS EKS
        run: |
          aws eks update-kubeconfig --region $AWS_REGION  --name $(aws eks list-clusters --region $AWS_REGION --query "clusters" --output text)

      - name: Deploy File-Checker Application to Kubernetes (AWS EKS) and Verfiy Deployment/Service
        run: |
          IMAGE_TAG="${ECR_REPOSITORY}-${GITHUB_REF_NAME}-${GITHUB_RUN_NUMBER}"
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}"
          sed -i "s|<ECR_URI>:latest|${ECR_URI}:${IMAGE_TAG}|g" k8s_manifest_files/deployment.yaml 
          echo "Patching BUCKET_NAME=${S3_BUCKET_NAME} into deployment.yaml"
          sed -i "s|BUCKET_NAME:.*|BUCKET_NAME: \"${S3_BUCKET_NAME}\"|g" k8s_manifest_files/deployment.yaml
          kubectl apply -f k8s_manifest_files/namespace.yaml
          kubectl apply -f k8s_manifest_files/deployment.yaml
          kubectl apply -f k8s_manifest_files/service.yaml
          kubectl apply -f k8s_manifest_files/service-account.yaml
          sleep 30
          kubectl get svc file-checker -n file-checker-app
          kubectl describe svc file-checker -n file-checker-app
          kubectl get pods -n file-checker-app
          kubectl logs -l app=file-checker --tail=50 -n file-checker-app


      - name: Check/Verfiy if File-Checker exists on S3 Bucket
        run: |
          lb=$(kubectl get svc file-checker -n file-checker-app -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          curl "${lb}:3000/check-file?fileName=${File_Name}"      

